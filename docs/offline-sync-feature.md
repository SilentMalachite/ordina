# オフライン同期機能ドキュメント

## 概要

Ordina在庫管理システムのオフライン同期機能により、インターネット接続が不安定な環境でもシステムを継続的に使用できます。この機能はNativePHP環境に最適化されており、ローカルのSQLiteデータベースを活用して完全なオフライン動作を実現しています。

## 実装された機能

### 1. オフラインデータ永続化

- **UUID同期フィールド**: 全テーブルに`uuid`、`last_synced_at`、`is_dirty`列を追加
- **HasSyncableFieldsトレイト**: モデルの自動UUID生成とダーティフラグ管理
- **ローカルストレージ**: オフライン時のフォーム送信をLocalStorageに保存

### 2. オンライン/オフライン状態管理

- **オンライン状態インジケーター**: 画面右上に常時表示
- **自動再接続検知**: オンライン復帰時に自動的に同期を開始
- **サーバーヘルスチェック**: `/api/health-check`エンドポイントで接続確認

### 3. 双方向同期

#### ローカル→サーバー同期（Push）
- `SyncLocalChangesToServerJob`: 未同期データをサーバーに送信
- ダーティフラグ（`is_dirty = true`）のレコードを検出して送信

#### サーバー→ローカル同期（Pull）
- `SyncFromServerJob`: サーバーの更新をローカルに反映
- タイムスタンプベースの差分同期

### 4. 競合解決

- **競合検出**: ローカルとサーバーで同じレコードが異なる値に更新された場合
- **手動解決UI**: モーダルダイアログで両方のデータを比較表示
- **解決方法**: ユーザーがローカルまたはサーバーのデータを選択

### 5. オフラインキュー処理

- **オフラインキュープロセッサー**: LocalStorageに保存されたリクエストを処理
- **自動再送**: オンライン復帰時に自動的にキューを処理
- **エラーハンドリング**: 失敗したリクエストの再試行

### 6. 自動定期同期

- **設定可能な同期間隔**: デフォルト5分（`config/sync.php`で変更可能）
- **バックグラウンド同期**: ユーザーの作業を妨げない
- **同期ステータス通知**: デスクトップ通知で同期状態を表示

## 使用方法

### オフライン時の操作

1. インターネット接続が切れると、画面右上のインジケーターがオフライン状態を表示
2. 通常通りデータの作成・編集・削除が可能
3. 変更はローカルデータベースに保存され、オンライン復帰時に自動同期

### 競合の解決

1. 競合が検出されると、自動的に競合解決モーダルが表示
2. ローカルとサーバーのデータを比較
3. どちらのデータを使用するか選択
4. 「後で解決」を選択すると、次回ページロード時に再度表示

### 手動同期

オンライン状態インジケーターをクリックすることで、手動同期を実行できます。

## 設定

`config/sync.php`で以下の設定が可能：

```php
return [
    'server_url' => env('SYNC_SERVER_URL', 'https://api.ordina.example.com'),
    'api_token' => env('SYNC_API_TOKEN'),
    'auto_sync_interval' => env('SYNC_INTERVAL', 300), // 秒単位
    'timeout' => env('SYNC_TIMEOUT', 30),
    'force_offline' => env('SYNC_FORCE_OFFLINE', false), // テスト用
];
```

## 技術的詳細

### データベース構造

各テーブルに追加された同期用フィールド：

- `uuid` (char(36)): グローバル一意識別子
- `last_synced_at` (timestamp): 最終同期日時
- `is_dirty` (boolean): 未同期フラグ

### API エンドポイント

- `GET /api/health-check`: サーバー接続確認
- `POST /api/sync/start`: 同期開始
- `POST /api/sync/push`: ローカル→サーバー同期
- `GET /api/sync/pull`: サーバー→ローカル同期
- `POST /api/sync/resolve-conflict`: 競合解決

### セキュリティ

- Sanctum認証による保護
- APIトークンベースの認証
- HTTPS通信の使用推奨

## トラブルシューティング

### 同期が失敗する場合

1. ネットワーク接続を確認
2. `storage/logs/laravel.log`でエラーログを確認
3. サーバーのAPIトークンが正しく設定されているか確認
4. `php artisan queue:work`が実行されているか確認

### 競合が頻繁に発生する場合

1. 複数ユーザーが同じデータを頻繁に編集している可能性
2. 同期間隔を短くすることを検討
3. データの編集権限を適切に設定

## 今後の改善点

1. **競合の自動解決**: 特定のルールに基づく自動解決オプション
2. **部分同期**: 大量データの効率的な同期
3. **同期履歴**: 同期操作の詳細なログと監査証跡
4. **オフライン期間の制限**: 長期間オフラインの場合の警告